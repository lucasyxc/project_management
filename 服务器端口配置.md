# 服务器端口配置说明

## 🔌 端口冲突解决方案

### 当前情况
- ❌ 80端口被占用
- ❌ 8000端口被占用

### 新的端口配置
- ✅ 前端: **8080端口**
- ✅ 后端: **8001端口**

---

## 📝 配置步骤

### 1. 后端配置（使用8001端口）

#### 开发模式
```bash
cd backend
python manage.py runserver 0.0.0.0:8001
```

#### 生产模式（Gunicorn）
```bash
cd backend
source venv/bin/activate
gunicorn --bind 0.0.0.0:8001 --workers 3 project_management.wsgi:application
```

#### Supervisor配置
编辑 `/etc/supervisor/conf.d/project_backend.conf`:
```ini
[program:project_backend]
command=/path/to/项目管理系统/backend/venv/bin/gunicorn --bind 127.0.0.1:8001 --workers 3 project_management.wsgi:application
directory=/path/to/项目管理系统/backend
user=your-user
autostart=true
autorestart=true
stdout_logfile=/var/log/project_backend.log
```

重启服务：
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl restart project_backend
```

---

### 2. 前端配置（Nginx使用8080端口）

#### Nginx配置文件
编辑 `/etc/nginx/sites-available/project-management`:

```nginx
server {
    listen 8080;  # 前端端口
    server_name your-server-ip;  # 改成你的服务器IP或域名

    # 前端静态文件
    location / {
        root /path/to/项目管理系统/dist;  # 改成实际路径
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8001;  # 后端端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Django管理后台
    location /admin/ {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
    }

    # 静态文件
    location /static/ {
        alias /path/to/项目管理系统/backend/staticfiles/;
    }

    # 媒体文件
    location /media/ {
        alias /path/to/项目管理系统/backend/media/;
    }
}
```

#### 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/project-management /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx
```

---

## 🌐 访问地址

配置完成后，访问地址如下：

- **前端首页**: http://your-server-ip:8080
- **测试页面**: http://your-server-ip:8080/test
- **管理后台**: http://your-server-ip:8080/admin
- **API文档**: http://your-server-ip:8080/api/docs/
- **API测试**: http://your-server-ip:8080/api/test/
- **健康检查**: http://your-server-ip:8080/api/health/

---

## 🔥 防火墙设置

确保防火墙开放端口：

### Ubuntu/Debian (UFW)
```bash
sudo ufw allow 8080/tcp
sudo ufw allow 8001/tcp
sudo ufw status
```

### CentOS/RHEL (firewalld)
```bash
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --permanent --add-port=8001/tcp
sudo firewall-cmd --reload
```

### 云服务器
记得在云服务商控制台的安全组中开放 **8080端口**

---

## 🔍 测试端口是否可用

### 检查端口占用
```bash
# 检查8001端口
sudo netstat -tlnp | grep 8001
# 或
sudo lsof -i :8001

# 检查8080端口
sudo netstat -tlnp | grep 8080
# 或
sudo lsof -i :8080
```

### 如果还是被占用
选择其他端口，例如：
- 前端: 8888, 9000, 3000
- 后端: 8002, 9001, 5001

只需修改上面配置中的端口号即可。

---

## 📋 快速测试清单

### ✅ 后端测试
```bash
# 直接访问后端
curl http://localhost:8001/api/test/

# 应该返回JSON
{"status":"success","message":"后端服务运行正常！",...}
```

### ✅ 前端测试
```bash
# 检查Nginx是否监听8080
sudo netstat -tlnp | grep 8080

# 浏览器访问
http://your-server-ip:8080
```

### ✅ 完整测试
1. 访问 http://your-server-ip:8080/test
2. 点击"测试后端连接"按钮
3. 应该显示"后端连接成功"

---

## 💡 提示

1. 每次修改Nginx配置后要重新加载：`sudo systemctl reload nginx`
2. 每次修改后端代码后要重启服务：`sudo supervisorctl restart project_backend`
3. 查看日志定位问题：
   - Nginx: `sudo tail -f /var/log/nginx/error.log`
   - 后端: `sudo tail -f /var/log/project_backend.log`

