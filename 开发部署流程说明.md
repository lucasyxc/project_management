# 开发部署流程说明

## 🎯 概述

本文档说明如何从本地开发到服务器部署的完整流程。

---

## 🔄 完整的开发部署流程

### 📝 日常开发流程

#### 1️⃣ 本地开发

**开发前端：**
```bash
cd frontend
npm run dev
```
访问：http://localhost:5173

**开发后端：**
```bash
cd backend
python -m venv venv                    # 创建虚拟环境（首次运行）
venv\Scripts\activate                  # 激活虚拟环境（Windows）
# source venv/bin/activate             # 激活虚拟环境（Linux/Mac）
pip install -r requirements.txt        # 安装依赖（首次运行）
python manage.py migrate               # 数据库迁移（首次运行）
python manage.py runserver
```
访问：http://localhost:8000

---

#### 2️⃣ 前端打包并推送

```bash
# 1. 打包前端
cd frontend
npm run build
cd ..

# 2. 推送到Git
git add .
git commit -m "更新功能描述"
git push
```

---

#### 3️⃣ 服务器更新

```bash
# SSH登录服务器
ssh ubuntu@1.14.110.116

# 进入项目目录
cd ~/projects/project_management

# 拉取最新代码
git pull origin master
```

---

#### 4️⃣ 更新后端依赖并重启

```bash
# 进入后端目录
cd backend

# 激活虚拟环境
source venv/bin/activate

# 更新依赖
pip install -r requirements.txt

# 数据库迁移（如果有新的迁移）
python manage.py migrate

# 重启后端（如果是用gunicorn运行）
pkill -f gunicorn
nohup gunicorn --bind 0.0.0.0:8001 --workers 3 project_management.wsgi:application > gunicorn.log 2>&1 &
```

---

#### 5️⃣ 前端自动更新

✅ **前端不需要重启**！

**原因：**
- 前端是静态文件（`dist/`文件夹）
- Nginx会自动服务最新的静态文件
- 只要 `git pull` 拉取了新的 `dist/` 文件，前端就自动更新了

---

## 🚀 一键部署脚本（推荐）

### 创建部署脚本

在服务器上创建自动化部署脚本：

```bash
# 创建部署脚本
nano ~/deploy.sh
```

### 脚本内容

```bash
#!/bin/bash
echo "开始部署..."

# 进入项目目录
cd ~/projects/project_management

# 拉取最新代码
echo "拉取最新代码..."
git pull origin master

# 进入后端目录
cd backend

# 激活虚拟环境
source venv/bin/activate

# 更新依赖
echo "更新依赖..."
pip install -r requirements.txt

# 数据库迁移
echo "执行数据库迁移..."
python manage.py migrate

# 重启后端服务
echo "重启后端服务..."
pkill -f gunicorn
nohup gunicorn --bind 0.0.0.0:8001 --workers 3 project_management.wsgi:application > gunicorn.log 2>&1 &

echo "部署完成！"
echo "访问地址: http://1.14.110.116:8080"
```

### 使用部署脚本

```bash
# 给脚本执行权限
chmod +x ~/deploy.sh

# 运行部署脚本
~/deploy.sh
```

---

## 📋 简化版流程（手动）

**每次更新只需要3步：**

### 步骤1：本地推送
```bash
# 打包并推送
cd frontend && npm run build && cd ..
git add . && git commit -m "更新内容" && git push
```

### 步骤2：服务器拉取
```bash
# SSH登录并拉取
ssh ubuntu@1.14.110.116
cd ~/projects/project_management && git pull origin master
```

### 步骤3：重启后端
```bash
# 重启后端服务
cd backend
source venv/bin/activate
pkill -f gunicorn
nohup gunicorn --bind 0.0.0.0:8001 --workers 3 project_management.wsgi:application > gunicorn.log 2>&1 &
```

---

## 🔧 常用命令

### 本地开发命令

```bash
# 启动前端开发服务器
cd frontend && npm run dev

# 启动后端开发服务器
cd backend
venv\Scripts\activate                  # Windows
# source venv/bin/activate             # Linux/Mac
python manage.py runserver

# 打包前端
cd frontend && npm run build

# Git操作
git add .
git commit -m "提交说明"
git push
```

### 服务器管理命令

```bash
# 查看后端进程
ps aux | grep gunicorn

# 查看后端日志
tail -f ~/projects/project_management/backend/gunicorn.log

# 重启Nginx
sudo systemctl reload nginx

# 查看Nginx状态
sudo systemctl status nginx

# 查看端口占用
sudo netstat -tlnp | grep 8001
sudo netstat -tlnp | grep 8080
```

---

## 🌐 访问地址

- **生产环境前端**: http://1.14.110.116:8080
- **生产环境测试页面**: http://1.14.110.116:8080/test
- **生产环境API**: http://1.14.110.116:8080/api/test/
- **管理后台**: http://1.14.110.116:8080/admin

---

## ⚠️ 注意事项

### 1. 端口配置
- **前端**: 8080端口（Nginx）
- **后端**: 8001端口（Gunicorn）
- **开发前端**: 5173端口（Vite）
- **开发后端**: 8000端口（Django）

### 2. 文件结构
```
项目管理系统/
├── backend/          # 后端代码（推送到Git）
├── frontend/         # 前端源码（不推送到Git）
├── dist/            # 前端打包产物（推送到Git）
└── 文档/            # 说明文档（推送到Git）
```

### 3. 环境变量
- 生产环境需要配置 `.env` 文件
- 开发环境使用默认配置即可
- 配置文件：`backend/env.production`（复制到服务器改名为`.env`）

### 4. 数据库
- **开发环境**：SQLite（无需配置，自动使用）
- **生产环境**：MySQL（需要先创建数据库，详见 `MySQL数据库配置.md`）
- 数据库：`project_management`（与旧项目`lens_order_dev`完全隔离）

---

## 🆘 故障排查

### 问题1：前端访问不了
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查8080端口
sudo netstat -tlnp | grep 8080

# 检查防火墙
sudo ufw status
```

### 问题2：后端API访问不了
```bash
# 检查后端进程
ps aux | grep gunicorn

# 检查8001端口
sudo netstat -tlnp | grep 8001

# 查看后端日志
tail -f gunicorn.log
```

### 问题3：Git推送失败
```bash
# 检查Git状态
git status

# 检查远程仓库
git remote -v

# 强制推送（谨慎使用）
git push --force
```

### 问题4：依赖安装失败
```bash
# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 升级pip
pip install --upgrade pip
```

---

## 📈 性能优化建议

### 1. 生产环境优化
- 使用Gunicorn + Nginx
- 启用Gzip压缩
- 配置静态文件缓存
- 使用CDN（可选）

### 2. 数据库优化
- 配置数据库连接池
- 添加数据库索引
- 定期清理日志

### 3. 监控建议
- 配置日志轮转
- 监控服务器资源使用
- 设置健康检查接口

---

## 🎯 总结

现在您拥有了完整的开发部署环境：

✅ **本地开发环境** - Vue3 + Django  
✅ **版本控制系统** - Git + GitHub  
✅ **生产部署环境** - Ubuntu + Nginx + Gunicorn  
✅ **自动化部署流程** - 一键部署脚本  
✅ **测试验证环境** - 完整的测试页面  

可以开始正式的项目开发了！🚀

---

**最后更新**: 2024年10月17日  
**服务器地址**: 1.14.110.116:8080  
**Git仓库**: https://github.com/lucasyxc/project_management.git
