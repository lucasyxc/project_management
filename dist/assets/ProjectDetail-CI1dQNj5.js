import{_ as fe,r as w,i as _e,x as G,o as ve,c as k,z as v,g as B,b as n,w as a,d,h as f,s as ge,E as i,e as u,f as r,t as _,a as x,F as D,v as U,B as ye,A as M}from"./index-TwG3oDm_.js";const be={class:"project-detail"},we={class:"card-header"},ke={style:{display:"flex","flex-wrap":"wrap",gap:"8px","align-items":"center"}},xe={class:"card-header"},$e={style:{"font-size":"16px"}},Ve={key:1},Ce={__name:"ProjectDetail",setup(Se){const I=ge(),o=w(null),T=w([]),$=w(!1),V=w(!1),y=w(null),C=w([]),p=_e({name:"",description:"",deadline:"",owner:null}),S=G(()=>!o.value||!o.value.stages?[]:[...o.value.stages].sort((l,e)=>l.order-e.order)),H=l=>({not_started:"info",in_progress:"warning",completed:"success",todo:"info",review:""})[l]||"info",J=l=>({not_started:"未开始",in_progress:"进行中",completed:"已完成",todo:"待办",review:"待审核"})[l]||l,K=l=>({low:"info",medium:"",high:"warning",urgent:"danger"})[l]||"",Q=l=>({low:"低",medium:"中",high:"高",urgent:"紧急"})[l]||l,W=G(()=>{if(!o.value||!T.value)return[];const l=(o.value.members_detail||[]).map(e=>e.id);return T.value.filter(e=>!l.includes(e.id))}),g=async()=>{try{const l=await f.get(`/api/projects/${I.params.id}/`);o.value=l.data}catch{i.error("加载项目详情失败")}},X=async()=>{try{const l=await f.get("/api/users/",{params:{page_size:100}});T.value=(l.data.results||[]).filter(e=>e.username!=="admin")}catch{console.error("加载用户列表失败")}},Z=l=>({in_progress:"warning",overdue:"danger",completed:"success"})[l]||"info",ee=l=>({in_progress:"进行中",overdue:"已超期",completed:"已完成"})[l]||l,P=l=>l.status==="overdue",te=l=>{y.value=l,Object.assign(p,{name:l.name,description:l.description||"",deadline:l.deadline||"",owner:l.owner||null}),$.value=!0},le=async()=>{if(!p.name){i.warning("请输入阶段名称");return}try{const l=S.value.length>0?Math.max(...S.value.map(s=>s.order)):-1,e={...p,project:I.params.id,order:y.value?y.value.order:l+1,status:"in_progress"};e.deadline||(e.deadline=null),e.owner||(e.owner=null),e.description||(e.description=""),y.value?(await f.put(`/api/projects/stages/${y.value.id}/`,e),i.success("阶段更新成功")):(await f.post("/api/projects/stages/",e),i.success("阶段添加成功")),N(),g()}catch{i.error("保存失败")}},ae=async l=>{try{const e=l.status==="overdue"?`阶段"${l.name}"已超期，确认完成吗？`:`确认完成阶段"${l.name}"吗？`;await M.confirm(e,"提示",{confirmButtonText:"确认完成",cancelButtonText:"取消",type:l.status==="overdue"?"warning":"success"}),await f.post(`/api/projects/stages/${l.id}/done/`),i.success("阶段已标记为完成"),g()}catch(e){e!=="cancel"&&i.error("操作失败")}},ne=async l=>{try{await M.confirm(`确认将阶段"${l.name}"改为重做中吗？`,"提示",{confirmButtonText:"确认重做",cancelButtonText:"取消",type:"warning"}),await f.post(`/api/projects/stages/${l.id}/redo/`),i.success("阶段已改为重做中"),g()}catch(e){e!=="cancel"&&i.error("操作失败")}},E=async(l,e)=>{try{const s=S.value,c=s.findIndex(m=>m.id===l.id);if(e==="up"&&c>0){const m=s[c-1];await f.patch(`/api/projects/stages/${l.id}/`,{order:m.order}),await f.patch(`/api/projects/stages/${m.id}/`,{order:l.order}),i.success("上移成功")}else if(e==="down"&&c<s.length-1){const m=s[c+1];await f.patch(`/api/projects/stages/${l.id}/`,{order:m.order}),await f.patch(`/api/projects/stages/${m.id}/`,{order:l.order}),i.success("下移成功")}g()}catch{i.error("操作失败")}},se=async l=>{try{await M.confirm(`确定要删除阶段"${l.name}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await f.delete(`/api/projects/stages/${l.id}/`),i.success("阶段删除成功"),g()}catch(e){e!=="cancel"&&i.error("删除失败")}},N=()=>{$.value=!1,y.value=null,Object.assign(p,{name:"",description:"",deadline:"",owner:null})},oe=async()=>{if(C.value.length===0){i.warning("请选择要添加的关联人");return}try{const e=[...(o.value.members_detail||[]).map(s=>s.id),...C.value];await f.patch(`/api/projects/${o.value.id}/`,{members:e}),i.success("关联人添加成功"),V.value=!1,C.value=[],g()}catch{i.error("添加失败")}},re=async l=>{try{await M.confirm(`确定要移除关联人"${l.username}"？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=(o.value.members_detail||[]).map(s=>s.id).filter(s=>s!==l.id);await f.patch(`/api/projects/${o.value.id}/`,{members:e}),i.success("关联人移除成功"),g()}catch(e){e!=="cancel"&&i.error("移除失败")}};return ve(()=>{g(),X()}),(l,e)=>{const s=d("el-button"),c=d("el-descriptions-item"),m=d("el-tag"),ie=d("el-progress"),O=d("Plus"),Y=d("el-icon"),de=d("el-descriptions"),F=d("el-card"),ue=d("el-empty"),b=d("el-table-column"),pe=d("el-table"),R=d("el-input"),z=d("el-form-item"),q=d("el-option"),A=d("el-select"),ce=d("el-date-picker"),me=d("el-form"),L=d("el-dialog");return u(),k("div",be,[o.value?(u(),v(F,{key:0},{header:a(()=>[x("div",we,[x("h2",null,_(o.value.name),1),n(s,{onClick:e[0]||(e[0]=t=>l.$router.back())},{default:a(()=>[...e[11]||(e[11]=[r("返回",-1)])]),_:1})])]),default:a(()=>[n(de,{column:2,border:""},{default:a(()=>[n(c,{label:"项目描述",span:2},{default:a(()=>[r(_(o.value.description||"无"),1)]),_:1}),n(c,{label:"状态"},{default:a(()=>[n(m,{type:H(o.value.status)},{default:a(()=>[r(_(J(o.value.status)),1)]),_:1},8,["type"])]),_:1}),n(c,{label:"优先级"},{default:a(()=>[n(m,{type:K(o.value.priority)},{default:a(()=>[r(_(Q(o.value.priority)),1)]),_:1},8,["type"])]),_:1}),n(c,{label:"负责人"},{default:a(()=>{var t;return[r(_((t=o.value.owner_detail)==null?void 0:t.username),1)]}),_:1}),n(c,{label:"进度"},{default:a(()=>[n(ie,{percentage:o.value.progress},null,8,["percentage"])]),_:1}),n(c,{label:"开始日期"},{default:a(()=>[r(_(o.value.start_date||"未设置"),1)]),_:1}),n(c,{label:"结束日期"},{default:a(()=>[r(_(o.value.end_date||"未设置"),1)]),_:1}),n(c,{label:"关联人",span:2},{default:a(()=>[x("div",ke,[(u(!0),k(D,null,U(o.value.members_detail||[],t=>(u(),v(m,{key:t.id,closable:"",onClose:h=>re(t),style:{"margin-right":"5px"}},{default:a(()=>[r(_(t.username),1)]),_:2},1032,["onClose"]))),128)),n(s,{size:"small",type:"primary",onClick:e[1]||(e[1]=t=>V.value=!0)},{default:a(()=>[n(Y,null,{default:a(()=>[n(O)]),_:1}),e[12]||(e[12]=r(" 添加关联人 ",-1))]),_:1})])]),_:1})]),_:1})]),_:1})):B("",!0),n(F,{style:{"margin-top":"20px"}},{header:a(()=>[x("div",xe,[e[14]||(e[14]=x("h3",null,"项目阶段",-1)),n(s,{type:"primary",size:"small",onClick:e[2]||(e[2]=t=>$.value=!0)},{default:a(()=>[n(Y,null,{default:a(()=>[n(O)]),_:1}),e[13]||(e[13]=r(" 添加阶段 ",-1))]),_:1})])]),default:a(()=>[!o.value||!o.value.stages||o.value.stages.length===0?(u(),v(ue,{key:0,description:"暂无阶段，点击上方按钮添加"})):(u(),v(pe,{key:1,data:S.value,stripe:""},{default:a(()=>[n(b,{label:"Step",width:"80",align:"center"},{default:a(({$index:t})=>[x("strong",$e,_(t+1),1)]),_:1}),n(b,{prop:"name",label:"阶段名称","min-width":"150"}),n(b,{prop:"description",label:"阶段描述","min-width":"200"},{default:a(({row:t})=>[r(_(t.description||"-"),1)]),_:1}),n(b,{prop:"owner_name",label:"负责人",width:"120"},{default:a(({row:t})=>[r(_(t.owner_name||"未指定"),1)]),_:1}),n(b,{label:"截止日期",width:"150"},{default:a(({row:t})=>[t.deadline?(u(),k("span",{key:0,style:ye({color:P(t)?"#f56c6c":""})},[r(_(t.deadline)+" ",1),P(t)?(u(),v(m,{key:0,type:"danger",size:"small",style:{"margin-left":"5px"}},{default:a(()=>[...e[15]||(e[15]=[r(" 已超期 ",-1)])]),_:1})):B("",!0)],4)):(u(),k("span",Ve,"-"))]),_:1}),n(b,{prop:"status",label:"状态",width:"100"},{default:a(({row:t})=>[n(m,{type:Z(t.status),size:"small"},{default:a(()=>[r(_(ee(t.status)),1)]),_:2},1032,["type"])]),_:1}),n(b,{label:"操作",width:"320",fixed:"right"},{default:a(({row:t,$index:h})=>[t.status!=="completed"?(u(),v(s,{key:0,link:"",type:t.status==="overdue"?"danger":"success",size:"small",onClick:j=>ae(t)},{default:a(()=>[...e[16]||(e[16]=[r(" Done ",-1)])]),_:1},8,["type","onClick"])):B("",!0),t.status==="completed"?(u(),v(s,{key:1,link:"",type:"warning",size:"small",onClick:j=>ne(t)},{default:a(()=>[...e[17]||(e[17]=[r(" Redo ",-1)])]),_:1},8,["onClick"])):B("",!0),n(s,{link:"",size:"small",disabled:h===0,onClick:j=>E(t,"up")},{default:a(()=>[...e[18]||(e[18]=[r(" 上移 ",-1)])]),_:1},8,["disabled","onClick"]),n(s,{link:"",size:"small",disabled:h===S.value.length-1,onClick:j=>E(t,"down")},{default:a(()=>[...e[19]||(e[19]=[r(" 下移 ",-1)])]),_:1},8,["disabled","onClick"]),n(s,{link:"",type:"primary",size:"small",onClick:j=>te(t)},{default:a(()=>[...e[20]||(e[20]=[r("编辑",-1)])]),_:1},8,["onClick"]),n(s,{link:"",type:"danger",size:"small",onClick:j=>se(t)},{default:a(()=>[...e[21]||(e[21]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1}),n(L,{modelValue:$.value,"onUpdate:modelValue":e[7]||(e[7]=t=>$.value=t),title:y.value?"编辑阶段":"添加阶段",width:"600px"},{footer:a(()=>[n(s,{onClick:N},{default:a(()=>[...e[22]||(e[22]=[r("取消",-1)])]),_:1}),n(s,{type:"primary",onClick:le},{default:a(()=>[...e[23]||(e[23]=[r("保存",-1)])]),_:1})]),default:a(()=>[n(me,{model:p,"label-width":"100px"},{default:a(()=>[n(z,{label:"阶段名称",required:""},{default:a(()=>[n(R,{modelValue:p.name,"onUpdate:modelValue":e[3]||(e[3]=t=>p.name=t),placeholder:"例如: Step1、需求分析阶段"},null,8,["modelValue"])]),_:1}),n(z,{label:"阶段描述"},{default:a(()=>[n(R,{modelValue:p.description,"onUpdate:modelValue":e[4]||(e[4]=t=>p.description=t),type:"textarea",rows:3,placeholder:"阶段说明（可不填）"},null,8,["modelValue"])]),_:1}),n(z,{label:"负责人"},{default:a(()=>[n(A,{modelValue:p.owner,"onUpdate:modelValue":e[5]||(e[5]=t=>p.owner=t),clearable:"",placeholder:"选择负责人（可不选）"},{default:a(()=>[(u(!0),k(D,null,U(T.value,t=>(u(),v(q,{key:t.id,label:`${t.username}${t.first_name?" - "+t.first_name+t.last_name:""}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(z,{label:"截止日期"},{default:a(()=>[n(ce,{modelValue:p.deadline,"onUpdate:modelValue":e[6]||(e[6]=t=>p.deadline=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"可不选"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(L,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=t=>V.value=t),title:"添加关联人",width:"400px"},{footer:a(()=>[n(s,{onClick:e[9]||(e[9]=t=>V.value=!1)},{default:a(()=>[...e[24]||(e[24]=[r("取消",-1)])]),_:1}),n(s,{type:"primary",onClick:oe},{default:a(()=>[...e[25]||(e[25]=[r("添加",-1)])]),_:1})]),default:a(()=>[n(A,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=t=>C.value=t),multiple:"",placeholder:"选择要添加的关联人",style:{width:"100%"}},{default:a(()=>[(u(!0),k(D,null,U(W.value,t=>(u(),v(q,{key:t.id,label:`${t.username}${t.first_name?" - "+t.first_name+t.last_name:""}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},Te=fe(Ce,[["__scopeId","data-v-76c4255b"]]);export{Te as default};
