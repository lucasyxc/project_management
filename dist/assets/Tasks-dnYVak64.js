import{_ as L,r as u,z as q,o as G,c as f,b as l,w as s,d as r,h as y,E as p,j as H,e as i,a as b,t as m,f as d,A as J,x as w,g as T,F as K,v as O,y as V}from"./index-DvnI5NRD.js";const Q={class:"tasks"},W={class:"card-header"},X={key:1},Y={__name:"Tasks",setup(Z){const B=H(),j=u([]),k=u([]),x=u(1),$=u(20),z=u(0),_=u(null),g=u(null),S=q(()=>{let e=j.value;return _.value&&(e=e.filter(a=>a.project===_.value)),g.value&&(e=e.filter(a=>a.status===g.value)),e}),E=e=>({in_progress:"warning",overdue:"danger",completed:"success"})[e]||"info",P=e=>({in_progress:"进行中",overdue:"已超期",completed:"已完成"})[e]||e,v=async()=>{try{const e=await y.get("/api/projects/stages/",{params:{page:x.value,page_size:100}}),a=e.data.results||[],c={};k.value.forEach(o=>{c[o.id]=o.name}),j.value=a.map(o=>({...o,project_name:c[o.project]||"未知项目"})),z.value=e.data.count||0}catch{p.error("加载任务列表失败")}},M=async()=>{try{const e=await y.get("/api/projects/",{params:{page_size:100}});k.value=e.data.results||[],v()}catch{p.error("加载项目列表失败")}},N=async e=>{try{const a=e.status==="overdue"?`任务"${e.name}"已超期，确认完成吗？`:`确认完成任务"${e.name}"吗？`;await V.confirm(a,"提示",{confirmButtonText:"确认完成",cancelButtonText:"取消",type:e.status==="overdue"?"warning":"success"}),await y.post(`/api/projects/stages/${e.id}/done/`),p.success("任务已标记为完成"),v()}catch(a){a!=="cancel"&&p.error("操作失败")}},D=async e=>{try{await V.confirm(`确认将任务"${e.name}"改为重做中吗？`,"提示",{confirmButtonText:"确认重做",cancelButtonText:"取消",type:"warning"}),await y.post(`/api/projects/stages/${e.id}/redo/`),p.success("任务已改为重做中"),v()}catch(a){a!=="cancel"&&p.error("操作失败")}},R=e=>{B.push(`/projects/${e}`)};return G(()=>{M()}),(e,a)=>{const c=r("el-option"),o=r("el-select"),n=r("el-table-column"),U=r("el-tag"),h=r("el-button"),F=r("el-table"),A=r("el-pagination"),I=r("el-card");return i(),f("div",Q,[l(I,null,{header:s(()=>[b("div",W,[a[3]||(a[3]=b("h3",null,"任务管理（所有项目的阶段）",-1)),b("div",null,[l(o,{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=t=>_.value=t),clearable:"",placeholder:"筛选项目",style:{width:"200px","margin-right":"10px"}},{default:s(()=>[(i(!0),f(K,null,O(k.value,t=>(i(),w(c,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(o,{modelValue:g.value,"onUpdate:modelValue":a[1]||(a[1]=t=>g.value=t),clearable:"",placeholder:"筛选状态",style:{width:"150px"}},{default:s(()=>[l(c,{label:"进行中",value:"in_progress"}),l(c,{label:"已超期",value:"overdue"}),l(c,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])])])]),default:s(()=>[l(F,{data:S.value,stripe:""},{default:s(()=>[l(n,{label:"Step",width:"80",align:"center"},{default:s(({row:t})=>[b("strong",null,m(t.order+1),1)]),_:1}),l(n,{prop:"project_name",label:"所属项目",width:"180"}),l(n,{prop:"name",label:"阶段名称","min-width":"150"}),l(n,{prop:"description",label:"描述","min-width":"200"},{default:s(({row:t})=>[d(m(t.description||"-"),1)]),_:1}),l(n,{prop:"owner_name",label:"负责人",width:"120"},{default:s(({row:t})=>[d(m(t.owner_name||"未指定"),1)]),_:1}),l(n,{prop:"deadline",label:"截止日期",width:"120"},{default:s(({row:t})=>[t.deadline?(i(),f("span",{key:0,style:J({color:t.status==="overdue"?"#f56c6c":""})},m(t.deadline),5)):(i(),f("span",X,"-"))]),_:1}),l(n,{prop:"status",label:"状态",width:"100"},{default:s(({row:t})=>[l(U,{type:E(t.status),size:"small"},{default:s(()=>[d(m(P(t.status)),1)]),_:2},1032,["type"])]),_:1}),l(n,{label:"操作",width:"180",fixed:"right"},{default:s(({row:t})=>[t.status!=="completed"?(i(),w(h,{key:0,link:"",type:t.status==="overdue"?"danger":"success",size:"small",onClick:C=>N(t)},{default:s(()=>[...a[4]||(a[4]=[d(" Done ",-1)])]),_:1},8,["type","onClick"])):T("",!0),t.status==="completed"?(i(),w(h,{key:1,link:"",type:"warning",size:"small",onClick:C=>D(t)},{default:s(()=>[...a[5]||(a[5]=[d(" Redo ",-1)])]),_:1},8,["onClick"])):T("",!0),l(h,{link:"",type:"primary",size:"small",onClick:C=>R(t.project)},{default:s(()=>[...a[6]||(a[6]=[d("查看项目",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),l(A,{"current-page":x.value,"onUpdate:currentPage":a[2]||(a[2]=t=>x.value=t),"page-size":$.value,total:z.value,layout:"total, prev, pager, next",onCurrentChange:v},null,8,["current-page","page-size","total"])]),_:1})])}}},te=L(Y,[["__scopeId","data-v-aaabd9bd"]]);export{te as default};
