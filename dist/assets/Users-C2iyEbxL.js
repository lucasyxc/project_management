import{_ as me,u as fe,r as d,i as ce,o as ve,c as G,x as I,g as T,b as a,l as k,w as t,d as u,h as _,E as n,e as c,a as q,F as H,v as J,f as i,t as x,y as j}from"./index-DvnI5NRD.js";const _e={class:"users"},ge={class:"card-header"},ye={class:"group-tags"},Ve={class:"card-header"},we={key:0,class:"form-tip"},be={key:0,class:"form-tip"},ke={__name:"Users",setup(xe){const g=fe(),M=d([]),E=d([]),F=d(1),K=d(20),R=d(0),U=d(!1),C=d(!1),$=d(!1),f=d(null),y=d(null),N=d(!1),S=d(null),B=d(""),w=d(""),s=ce({username:"",password:"",email:"",first_name:"",last_name:"",phone:"",department:"",position:"",group:null,is_active:!0}),Q={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:30,message:"用户名长度3-30字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}]},b=async()=>{try{const o=await _.get("/api/users/",{params:{page:F.value}});M.value=o.data.results||[],R.value=o.data.count||0}catch{n.error("加载用户列表失败")}},D=async()=>{try{const o=await _.get("/api/users/groups/");E.value=o.data.results||o.data||[]}catch{console.error("加载分组失败")}},W=async()=>{if(!B.value){n.warning("请输入分组名称");return}try{await _.post("/api/users/groups/",{name:B.value}),n.success("分组创建成功"),B.value="",C.value=!1,D()}catch{n.error("创建失败")}},X=o=>{y.value=o,w.value=o.name,$.value=!0},Y=async()=>{if(!w.value){n.warning("请输入分组名称");return}try{await _.put(`/api/users/groups/${y.value.id}/`,{name:w.value,description:y.value.description}),n.success("分组更新成功"),$.value=!1,y.value=null,w.value="",D()}catch{n.error("更新失败")}},Z=()=>{$.value=!1,y.value=null,w.value=""},ee=async o=>{try{await j.confirm(`确定删除分组"${o.name}"？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await _.delete(`/api/users/groups/${o.id}/`),n.success("分组删除成功"),D(),b()}catch(e){e!=="cancel"&&n.error("删除失败")}},le=o=>{f.value=o,Object.assign(s,{username:o.username,password:"",email:o.email||"",first_name:o.first_name||"",last_name:o.last_name||"",phone:o.phone||"",department:o.department||"",position:o.position||"",group:o.group||null,is_active:o.is_active}),U.value=!0},ae=async()=>{var o;try{await S.value.validate(),N.value=!0;const e={...s};f.value?(e.password||delete e.password,delete e.username,await _.put(`/api/users/${f.value.id}/`,e),n.success("用户更新成功")):(await _.post("/api/users/",e),n.success("子账号创建成功")),O(),b()}catch(e){if((o=e.response)!=null&&o.data){const r=e.response.data;r.username?n.error(`用户名: ${r.username[0]}`):r.password?n.error(`密码: ${r.password[0]}`):n.error("保存失败，请检查输入")}else n.error("保存失败")}finally{N.value=!1}},te=async o=>{try{const e=o.is_active?"禁用":"激活";await j.confirm(`确定要${e}用户 ${o.username} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await _.patch(`/api/users/${o.id}/`,{is_active:!o.is_active}),n.success(`${e}成功`),b()}catch(e){e!=="cancel"&&n.error("操作失败")}},oe=async o=>{try{await j.confirm(`确定要删除用户 ${o.username} 吗？此操作不可恢复！`,"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"error"}),await _.delete(`/api/users/${o.id}/`),n.success("用户删除成功"),b()}catch(e){e!=="cancel"&&n.error("删除失败")}},O=()=>{var o;U.value=!1,f.value=null,(o=S.value)==null||o.resetFields(),Object.assign(s,{username:"",password:"",email:"",first_name:"",last_name:"",phone:"",department:"",position:"",group:null,is_active:!0})};return ve(async()=>{g.userInfo||await g.getUserInfo(),b(),D()}),(o,e)=>{const r=u("el-button"),h=u("el-tag"),L=u("el-card"),se=u("Plus"),ne=u("el-icon"),v=u("el-table-column"),re=u("el-table"),ue=u("el-pagination"),p=u("el-input"),m=u("el-form-item"),z=u("el-col"),ie=u("el-option"),de=u("el-select"),pe=u("el-switch"),A=u("el-form"),P=u("el-dialog");return c(),G("div",_e,[k(g).userInfo&&(k(g).userInfo.is_staff||k(g).userInfo.is_superuser)?(c(),I(L,{key:0,style:{"margin-bottom":"15px"}},{header:t(()=>[q("div",ge,[e[21]||(e[21]=q("h3",null,"用户分组",-1)),a(r,{type:"primary",size:"small",onClick:e[0]||(e[0]=l=>C.value=!0)},{default:t(()=>[...e[20]||(e[20]=[i(" 新建分组 ",-1)])]),_:1})])]),default:t(()=>[q("div",ye,[(c(!0),G(H,null,J(E.value,l=>(c(),I(h,{key:l.id,closable:"",onClose:V=>ee(l),style:{"margin-right":"10px",cursor:"pointer"},onClick:V=>X(l)},{default:t(()=>[i(x(l.name)+" ("+x(l.member_count)+"人) ",1)]),_:2},1032,["onClose","onClick"]))),128))])]),_:1})):T("",!0),a(L,null,{header:t(()=>[q("div",Ve,[e[23]||(e[23]=q("h3",null,"用户管理",-1)),a(r,{type:"primary",onClick:e[1]||(e[1]=l=>U.value=!0)},{default:t(()=>[a(ne,null,{default:t(()=>[a(se)]),_:1}),e[22]||(e[22]=i(" 创建子账号 ",-1))]),_:1})])]),default:t(()=>[a(re,{data:M.value,stripe:""},{default:t(()=>[a(v,{prop:"username",label:"用户名",width:"120"}),a(v,{prop:"group_name",label:"分组",width:"120"}),a(v,{prop:"email",label:"邮箱",width:"200"}),a(v,{label:"姓名",width:"150"},{default:t(({row:l})=>[i(x(l.first_name)+" "+x(l.last_name),1)]),_:1}),a(v,{prop:"department",label:"部门",width:"120"}),a(v,{prop:"position",label:"职位",width:"120"}),a(v,{prop:"is_active",label:"状态",width:"100"},{default:t(({row:l})=>[a(h,{type:l.is_active?"success":"danger"},{default:t(()=>[i(x(l.is_active?"激活":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(v,{prop:"date_joined",label:"创建时间",width:"180"}),a(v,{label:"操作",width:"200",fixed:"right"},{default:t(({row:l})=>[a(r,{link:"",type:"primary",onClick:V=>le(l)},{default:t(()=>[...e[24]||(e[24]=[i("编辑",-1)])]),_:1},8,["onClick"]),a(r,{link:"",type:"warning",onClick:V=>te(l)},{default:t(()=>[i(x(l.is_active?"禁用":"激活"),1)]),_:2},1032,["onClick"]),a(r,{link:"",type:"danger",onClick:V=>oe(l)},{default:t(()=>[...e[25]||(e[25]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),a(ue,{"current-page":F.value,"onUpdate:currentPage":e[2]||(e[2]=l=>F.value=l),"page-size":K.value,total:R.value,layout:"total, prev, pager, next",onCurrentChange:b},null,8,["current-page","page-size","total"])]),_:1}),a(P,{modelValue:U.value,"onUpdate:modelValue":e[13]||(e[13]=l=>U.value=l),title:f.value?"编辑用户":"创建子账号",width:"600px"},{footer:t(()=>[a(r,{onClick:O},{default:t(()=>[...e[27]||(e[27]=[i("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:ae,loading:N.value},{default:t(()=>[...e[28]||(e[28]=[i("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(A,{model:s,rules:Q,ref_key:"userFormRef",ref:S,"label-width":"100px"},{default:t(()=>[a(m,{label:"用户名",prop:"username",required:!f.value},{default:t(()=>[a(p,{modelValue:s.username,"onUpdate:modelValue":e[3]||(e[3]=l=>s.username=l),disabled:!!f.value,placeholder:"登录账号"},null,8,["modelValue","disabled"]),f.value?T("",!0):(c(),G("div",we,"用户名创建后不可修改"))]),_:1},8,["required"]),a(m,{label:"密码",prop:"password",required:!f.value},{default:t(()=>[a(p,{modelValue:s.password,"onUpdate:modelValue":e[4]||(e[4]=l=>s.password=l),type:"password",placeholder:"至少6位","show-password":""},null,8,["modelValue"]),f.value?(c(),G("div",be,"留空表示不修改密码")):T("",!0)]),_:1},8,["required"]),a(m,{label:"邮箱",prop:"email"},{default:t(()=>[a(p,{modelValue:s.email,"onUpdate:modelValue":e[5]||(e[5]=l=>s.email=l),placeholder:"user@example.com"},null,8,["modelValue"])]),_:1}),a(m,{label:"姓名"},{default:t(()=>[a(z,{span:11},{default:t(()=>[a(p,{modelValue:s.first_name,"onUpdate:modelValue":e[6]||(e[6]=l=>s.first_name=l),placeholder:"姓"},null,8,["modelValue"])]),_:1}),a(z,{span:2,style:{"text-align":"center"}},{default:t(()=>[...e[26]||(e[26]=[i("-",-1)])]),_:1}),a(z,{span:11},{default:t(()=>[a(p,{modelValue:s.last_name,"onUpdate:modelValue":e[7]||(e[7]=l=>s.last_name=l),placeholder:"名"},null,8,["modelValue"])]),_:1})]),_:1}),a(m,{label:"手机号"},{default:t(()=>[a(p,{modelValue:s.phone,"onUpdate:modelValue":e[8]||(e[8]=l=>s.phone=l),placeholder:"手机号码"},null,8,["modelValue"])]),_:1}),a(m,{label:"部门"},{default:t(()=>[a(p,{modelValue:s.department,"onUpdate:modelValue":e[9]||(e[9]=l=>s.department=l),placeholder:"所属部门"},null,8,["modelValue"])]),_:1}),a(m,{label:"职位"},{default:t(()=>[a(p,{modelValue:s.position,"onUpdate:modelValue":e[10]||(e[10]=l=>s.position=l),placeholder:"职位名称"},null,8,["modelValue"])]),_:1}),k(g).userInfo&&(k(g).userInfo.is_staff||k(g).userInfo.is_superuser)?(c(),I(m,{key:0,label:"所属分组"},{default:t(()=>[a(de,{modelValue:s.group,"onUpdate:modelValue":e[11]||(e[11]=l=>s.group=l),clearable:"",placeholder:"选择分组（可不选）",style:{width:"100%"}},{default:t(()=>[(c(!0),G(H,null,J(E.value,l=>(c(),I(ie,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):T("",!0),a(m,{label:"状态"},{default:t(()=>[a(pe,{modelValue:s.is_active,"onUpdate:modelValue":e[12]||(e[12]=l=>s.is_active=l),"active-text":"激活","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(P,{modelValue:C.value,"onUpdate:modelValue":e[16]||(e[16]=l=>C.value=l),title:"新建分组",width:"400px"},{footer:t(()=>[a(r,{onClick:e[15]||(e[15]=l=>C.value=!1)},{default:t(()=>[...e[29]||(e[29]=[i("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:W},{default:t(()=>[...e[30]||(e[30]=[i("创建",-1)])]),_:1})]),default:t(()=>[a(p,{modelValue:B.value,"onUpdate:modelValue":e[14]||(e[14]=l=>B.value=l),placeholder:"输入分组名称"},null,8,["modelValue"])]),_:1},8,["modelValue"]),a(P,{modelValue:$.value,"onUpdate:modelValue":e[19]||(e[19]=l=>$.value=l),title:"编辑分组",width:"400px"},{footer:t(()=>[a(r,{onClick:Z},{default:t(()=>[...e[31]||(e[31]=[i("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:Y},{default:t(()=>[...e[32]||(e[32]=[i("保存",-1)])]),_:1})]),default:t(()=>[a(A,null,{default:t(()=>{var l;return[a(m,{label:"分组名称"},{default:t(()=>[a(p,{modelValue:w.value,"onUpdate:modelValue":e[17]||(e[17]=V=>w.value=V),placeholder:"输入分组名称"},null,8,["modelValue"])]),_:1}),(l=y.value)!=null&&l.description?(c(),I(m,{key:0,label:"描述"},{default:t(()=>[a(p,{modelValue:y.value.description,"onUpdate:modelValue":e[18]||(e[18]=V=>y.value.description=V),type:"textarea",placeholder:"分组描述",rows:3},null,8,["modelValue"])]),_:1})):T("",!0)]}),_:1})]),_:1},8,["modelValue"])])}}},Ce=me(ke,[["__scopeId","data-v-f02f33d1"]]);export{Ce as default};
