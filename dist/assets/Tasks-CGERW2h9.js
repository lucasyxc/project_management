import{_ as q,u as G,r as u,z as H,o as J,c as v,b as s,w as l,d as c,h as y,E as p,j as K,e as i,a as b,t as m,f as d,A as O,x as w,g as V,F as Q,v as W,y as B}from"./index-DbjfBYFQ.js";const X={class:"tasks"},Y={class:"card-header"},Z={key:1},ee={__name:"Tasks",setup(te){const S=K(),j=G(),z=u([]),k=u([]),x=u(1),$=u(20),C=u(0),_=u(null),f=u(null),E=H(()=>{var a;let e=z.value;return(a=j.userInfo)!=null&&a.id&&(e=e.filter(o=>o.owner===j.userInfo.id)),_.value&&(e=e.filter(o=>o.project===_.value)),f.value&&(e=e.filter(o=>o.status===f.value)),e}),P=e=>({in_progress:"warning",overdue:"danger",completed:"success"})[e]||"info",M=e=>({in_progress:"进行中",overdue:"已超期",completed:"已完成"})[e]||e,g=async()=>{try{const e=await y.get("/api/projects/stages/",{params:{page:x.value,page_size:100}}),a=e.data.results||[],o={};k.value.forEach(n=>{o[n.id]=n.name}),z.value=a.map(n=>({...n,project_name:o[n.project]||"未知项目"})),C.value=e.data.count||0}catch{p.error("加载任务列表失败")}},N=async()=>{try{const e=await y.get("/api/projects/",{params:{page_size:100}});k.value=e.data.results||[],g()}catch{p.error("加载项目列表失败")}},U=async e=>{try{const a=e.status==="overdue"?`任务"${e.name}"已超期，确认完成吗？`:`确认完成任务"${e.name}"吗？`;await B.confirm(a,"提示",{confirmButtonText:"确认完成",cancelButtonText:"取消",type:e.status==="overdue"?"warning":"success"}),await y.post(`/api/projects/stages/${e.id}/done/`),p.success("任务已标记为完成"),g()}catch(a){a!=="cancel"&&p.error("操作失败")}},D=async e=>{try{await B.confirm(`确认将任务"${e.name}"改为重做中吗？`,"提示",{confirmButtonText:"确认重做",cancelButtonText:"取消",type:"warning"}),await y.post(`/api/projects/stages/${e.id}/redo/`),p.success("任务已改为重做中"),g()}catch(a){a!=="cancel"&&p.error("操作失败")}},I=e=>{S.push(`/projects/${e}`)};return J(()=>{N()}),(e,a)=>{const o=c("el-option"),n=c("el-select"),r=c("el-table-column"),R=c("el-tag"),h=c("el-button"),F=c("el-table"),A=c("el-pagination"),L=c("el-card");return i(),v("div",X,[s(L,null,{header:l(()=>[b("div",Y,[a[3]||(a[3]=b("h3",null,"我的任务",-1)),b("div",null,[s(n,{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=t=>_.value=t),clearable:"",placeholder:"筛选项目",style:{width:"200px","margin-right":"10px"}},{default:l(()=>[(i(!0),v(Q,null,W(k.value,t=>(i(),w(o,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(n,{modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=t=>f.value=t),clearable:"",placeholder:"筛选状态",style:{width:"150px"}},{default:l(()=>[s(o,{label:"进行中",value:"in_progress"}),s(o,{label:"已超期",value:"overdue"}),s(o,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])])])]),default:l(()=>[s(F,{data:E.value,stripe:""},{default:l(()=>[s(r,{label:"Step",width:"80",align:"center"},{default:l(({row:t})=>[b("strong",null,m(t.order+1),1)]),_:1}),s(r,{prop:"project_name",label:"所属项目",width:"180"}),s(r,{prop:"name",label:"阶段名称","min-width":"150"}),s(r,{prop:"description",label:"描述","min-width":"200"},{default:l(({row:t})=>[d(m(t.description||"-"),1)]),_:1}),s(r,{prop:"owner_name",label:"负责人",width:"120"},{default:l(({row:t})=>[d(m(t.owner_name||"未指定"),1)]),_:1}),s(r,{prop:"deadline",label:"截止日期",width:"120"},{default:l(({row:t})=>[t.deadline?(i(),v("span",{key:0,style:O({color:t.status==="overdue"?"#f56c6c":""})},m(t.deadline),5)):(i(),v("span",Z,"-"))]),_:1}),s(r,{prop:"status",label:"状态",width:"100"},{default:l(({row:t})=>[s(R,{type:P(t.status),size:"small"},{default:l(()=>[d(m(M(t.status)),1)]),_:2},1032,["type"])]),_:1}),s(r,{label:"操作",width:"180",fixed:"right"},{default:l(({row:t})=>[t.status!=="completed"?(i(),w(h,{key:0,link:"",type:t.status==="overdue"?"danger":"success",size:"small",onClick:T=>U(t)},{default:l(()=>[...a[4]||(a[4]=[d(" Done ",-1)])]),_:1},8,["type","onClick"])):V("",!0),t.status==="completed"?(i(),w(h,{key:1,link:"",type:"warning",size:"small",onClick:T=>D(t)},{default:l(()=>[...a[5]||(a[5]=[d(" Redo ",-1)])]),_:1},8,["onClick"])):V("",!0),s(h,{link:"",type:"primary",size:"small",onClick:T=>I(t.project)},{default:l(()=>[...a[6]||(a[6]=[d("查看项目",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),s(A,{"current-page":x.value,"onUpdate:currentPage":a[2]||(a[2]=t=>x.value=t),"page-size":$.value,total:C.value,layout:"total, prev, pager, next",onCurrentChange:g},null,8,["current-page","page-size","total"])]),_:1})])}}},se=q(ee,[["__scopeId","data-v-786af9fe"]]);export{se as default};
