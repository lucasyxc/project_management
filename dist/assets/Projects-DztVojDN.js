import{_ as re,r as _,i as A,x as q,y as oe,o as ne,c as m,b as l,z as U,g as O,w as r,d,F as $,v as j,h as D,E as w,e as u,a as c,f,t as b,k as I,A as ie}from"./index-TwG3oDm_.js";const ue={class:"mobile-projects"},de={class:"filter-row"},pe={class:"filter-row",style:{"margin-top":"8px"}},ce={key:0,class:"empty-tip"},me={key:1,class:"project-list"},ge={class:"project-header"},ve={class:"project-title"},_e={class:"project-info"},fe={key:0,class:"current-stage"},ye={key:0,class:"deadline"},we={class:"project-progress"},be={class:"project-actions"},Ve={__name:"Projects",setup(xe){const E=_([]),z=_([]),x=_(!1),k=_(null),o=A({owner:"",priority:"",status:"not_started,in_progress"}),y=_(""),h=_("desc"),C=_(1),F=_(5),n=A({name:"",description:"",status:"not_started",priority:"low",owner:null,members:[]}),G=a=>({not_started:"info",in_progress:"warning",completed:"success"})[a]||"info",H=a=>({not_started:"未开始",in_progress:"进行中",completed:"已完成"})[a]||a,J=a=>({low:"info",medium:"",high:"warning",urgent:"danger"})[a]||"",K=a=>({low:"低",medium:"中",high:"高",urgent:"紧急"})[a]||a,Q=a=>a?new Date(a).toLocaleDateString("zh-CN"):"",T=q(()=>{let a=[...E.value];if(o.owner&&(a=a.filter(e=>e.owner===o.owner)),o.priority&&(a=a.filter(e=>e.priority===o.priority)),o.status){const e=o.status.split(",");a=a.filter(s=>e.includes(s.status))}return a.sort((e,s)=>{if(!y.value){const p=V=>!V.current_stage||!V.current_stage.deadline?new Date("9999-12-31"):new Date(V.current_stage.deadline),g=p(e),v=p(s);if(g.getTime()!==v.getTime())return g-v;const B={urgent:4,high:3,medium:2,low:1};return(B[s.priority]||0)-(B[e.priority]||0)}let i=0;switch(y.value){case"priority":const p={urgent:4,high:3,medium:2,low:1};i=(p[e.priority]||0)-(p[s.priority]||0);break;case"deadline":const g=v=>!v.current_stage||!v.current_stage.deadline?new Date("9999-12-31"):new Date(v.current_stage.deadline);i=g(e)-g(s);break;case"progress":i=e.progress-s.progress;break;default:return 0}return h.value==="desc"?-i:i}),a}),R=q(()=>{const a=(C.value-1)*F.value,e=a+F.value;return T.value.slice(a,e)}),W=()=>{o.owner="",o.priority="",o.status="not_started,in_progress",y.value="",h.value="desc",C.value=1},N=async()=>{try{const a=await D.get("/api/projects/");E.value=a.data.results||[]}catch{w.error("加载项目列表失败")}},X=async()=>{try{const a=await D.get("/api/users/",{params:{page_size:100}});z.value=(a.data.results||[]).filter(e=>e.username!=="admin")}catch{console.error("加载用户列表失败")}},Y=a=>{k.value=a,Object.assign(n,{...a,members:a.members||[]}),x.value=!0},Z=async()=>{if(!n.name){w.warning("请输入项目名称");return}try{const a={...n};a.owner||(a.owner=null),a.description||(a.description=""),k.value?(await D.put(`/api/projects/${k.value.id}/`,a),w.success("项目更新成功")):(await D.post("/api/projects/",a),w.success("项目创建成功")),M(),N()}catch{w.error("保存失败")}},M=()=>{x.value=!1,k.value=null,Object.assign(n,{name:"",description:"",status:"not_started",priority:"low",owner:null,members:[]})},ee=async a=>{try{await ie.confirm("确定要删除此项目吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await D.delete(`/api/projects/${a.id}/`),w.success("项目删除成功"),N()}catch(e){e!=="cancel"&&w.error("删除失败")}};return oe([o,y,h],()=>{C.value=1},{deep:!0}),ne(()=>{N(),X()}),(a,e)=>{const s=d("el-option"),i=d("el-select"),p=d("el-button"),g=d("el-card"),v=d("Plus"),B=d("el-icon"),V=d("el-tag"),te=d("el-progress"),le=d("el-pagination"),S=d("el-input"),P=d("el-form-item"),ae=d("el-form"),se=d("el-dialog");return u(),m("div",ue,[l(g,{class:"filter-card"},{default:r(()=>[c("div",de,[l(i,{modelValue:o.owner,"onUpdate:modelValue":e[0]||(e[0]=t=>o.owner=t),clearable:"",placeholder:"负责人",style:{flex:"1","margin-right":"8px"}},{default:r(()=>[(u(!0),m($,null,j(z.value,t=>(u(),U(s,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(i,{modelValue:o.priority,"onUpdate:modelValue":e[1]||(e[1]=t=>o.priority=t),clearable:"",placeholder:"优先级",style:{flex:"1","margin-right":"8px"}},{default:r(()=>[l(s,{label:"低",value:"low"}),l(s,{label:"中",value:"medium"}),l(s,{label:"高",value:"high"}),l(s,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"]),l(i,{modelValue:o.status,"onUpdate:modelValue":e[2]||(e[2]=t=>o.status=t),placeholder:"状态",style:{flex:"1"}},{default:r(()=>[l(s,{label:"全部",value:""}),l(s,{label:"未开始",value:"not_started"}),l(s,{label:"进行中",value:"in_progress"}),l(s,{label:"已完成",value:"completed"}),l(s,{label:"进行中和未开始",value:"not_started,in_progress"})]),_:1},8,["modelValue"])]),c("div",pe,[l(i,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=t=>y.value=t),placeholder:"排序字段",style:{flex:"1","margin-right":"8px"}},{default:r(()=>[l(s,{label:"默认排序",value:""}),l(s,{label:"优先级",value:"priority"}),l(s,{label:"截止日期",value:"deadline"}),l(s,{label:"进度",value:"progress"})]),_:1},8,["modelValue"]),l(i,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=t=>h.value=t),placeholder:"排序方式",style:{flex:"1","margin-right":"8px"},disabled:!y.value},{default:r(()=>[l(s,{label:"升序",value:"asc"}),l(s,{label:"降序",value:"desc"})]),_:1},8,["modelValue","disabled"]),l(p,{onClick:W,style:{flex:"0 0 auto"}},{default:r(()=>[...e[13]||(e[13]=[f("重置",-1)])]),_:1})])]),_:1}),l(p,{type:"primary",style:{width:"100%",margin:"10px 0"},onClick:e[5]||(e[5]=t=>x.value=!0)},{default:r(()=>[l(B,null,{default:r(()=>[l(v)]),_:1}),e[14]||(e[14]=f(" 新建项目 ",-1))]),_:1}),T.value.length===0?(u(),m("div",ce,"暂无项目")):(u(),m("div",me,[(u(!0),m($,null,j(R.value,t=>(u(),U(g,{key:t.id,class:"project-card",onClick:L=>a.$router.push(`/m/projects/${t.id}`)},{default:r(()=>[c("div",ge,[c("div",ve,b(t.name),1),l(V,{type:G(t.status),size:"small"},{default:r(()=>[f(b(H(t.status)),1)]),_:2},1032,["type"])]),c("div",_e,[c("span",null,"负责人: "+b(t.owner_name||"未指定"),1),l(V,{type:J(t.priority),size:"small"},{default:r(()=>[f(b(K(t.priority)),1)]),_:2},1032,["type"])]),t.current_stage?(u(),m("div",fe,[c("span",null,"当前步骤: "+b(t.current_stage.name),1),t.current_stage.deadline?(u(),m("span",ye," 截止: "+b(Q(t.current_stage.deadline)),1)):O("",!0)])):O("",!0),c("div",we,[e[15]||(e[15]=c("span",null,"进度",-1)),l(te,{percentage:t.progress,"show-text":!1,style:{flex:"1",margin:"0 10px"}},null,8,["percentage"]),c("span",null,b(t.progress)+"%",1)]),c("div",be,[l(p,{link:"",type:"primary",size:"small",onClick:I(L=>Y(t),["stop"])},{default:r(()=>[...e[16]||(e[16]=[f("编辑",-1)])]),_:1},8,["onClick"]),l(p,{link:"",type:"danger",size:"small",onClick:I(L=>ee(t),["stop"])},{default:r(()=>[...e[17]||(e[17]=[f("删除",-1)])]),_:1},8,["onClick"])])]),_:2},1032,["onClick"]))),128))])),T.value.length>0?(u(),U(le,{key:2,"current-page":C.value,"onUpdate:currentPage":e[6]||(e[6]=t=>C.value=t),"page-size":F.value,total:T.value.length,layout:"prev, pager, next",small:"",style:{"margin-top":"15px","justify-content":"center"}},null,8,["current-page","page-size","total"])):O("",!0),l(se,{modelValue:x.value,"onUpdate:modelValue":e[12]||(e[12]=t=>x.value=t),title:k.value?"编辑项目":"新建项目",fullscreen:!0},{footer:r(()=>[l(p,{onClick:M,style:{width:"48%"}},{default:r(()=>[...e[19]||(e[19]=[f("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:Z,style:{width:"48%"}},{default:r(()=>[...e[20]||(e[20]=[f("保存",-1)])]),_:1})]),default:r(()=>[l(ae,{model:n,"label-position":"top"},{default:r(()=>[l(P,{label:"项目名称",required:""},{default:r(()=>[l(S,{modelValue:n.name,"onUpdate:modelValue":e[7]||(e[7]=t=>n.name=t),placeholder:"输入项目名称"},null,8,["modelValue"])]),_:1}),l(P,{label:"项目负责人"},{default:r(()=>[l(i,{modelValue:n.owner,"onUpdate:modelValue":e[8]||(e[8]=t=>n.owner=t),clearable:"",placeholder:"选择负责人（可不选）",style:{width:"100%"}},{default:r(()=>[(u(!0),m($,null,j(z.value,t=>(u(),U(s,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(P,{label:"项目关联人"},{default:r(()=>[l(i,{modelValue:n.members,"onUpdate:modelValue":e[9]||(e[9]=t=>n.members=t),multiple:"",clearable:"",placeholder:"选择关联人（可多选）",style:{width:"100%"}},{default:r(()=>[(u(!0),m($,null,j(z.value,t=>(u(),U(s,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[18]||(e[18]=c("div",{style:{"font-size":"12px",color:"#909399","margin-top":"5px"}}," 关联人可以查看和管理此项目 ",-1))]),_:1}),l(P,{label:"项目描述"},{default:r(()=>[l(S,{modelValue:n.description,"onUpdate:modelValue":e[10]||(e[10]=t=>n.description=t),type:"textarea",rows:4,placeholder:"项目描述（可不填）"},null,8,["modelValue"])]),_:1}),l(P,{label:"优先级"},{default:r(()=>[l(i,{modelValue:n.priority,"onUpdate:modelValue":e[11]||(e[11]=t=>n.priority=t),style:{width:"100%"}},{default:r(()=>[l(s,{label:"低",value:"low"}),l(s,{label:"中",value:"medium"}),l(s,{label:"高",value:"high"}),l(s,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},he=re(Ve,[["__scopeId","data-v-3cee91e4"]]);export{he as default};
