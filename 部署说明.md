# 部署说明文档

## 快速部署流程

### 第一步：本地开发并打包

```bash
# 1. 开发前端
cd frontend
npm run dev

# 2. 前端打包
npm run build
# 打包产物会自动输出到根目录的 dist/ 文件夹

# 3. 开发后端
cd ../backend
python manage.py runserver

# 4. 提交代码到Git
cd ..
git add backend/ dist/ *.md
git commit -m "更新功能"
git push origin main
```

### 第二步：服务器拉取代码

```bash
# SSH连接服务器
ssh your-user@your-server-ip

# 进入项目目录
cd /path/to/项目管理系统

# 拉取最新代码
git pull origin main
```

### 第三步：更新服务器

```bash
# 运行一键部署脚本
./deploy.sh
```

## Git仓库说明

### 推送到Git的内容
- ✅ `backend/` - Django后端完整代码
- ✅ `dist/` - 前端打包产物（index.html及相关js、css）
- ✅ `*.md` - 根目录的说明文档
- ✅ `deploy.sh` - 部署脚本
- ✅ `.gitignore` - Git忽略配置

### 不推送到Git的内容
- ❌ `frontend/` - 前端开发源代码（通过.gitignore忽略）
- ❌ `node_modules/` - 依赖包
- ❌ `venv/` - Python虚拟环境
- ❌ `__pycache__/` - Python缓存
- ❌ `.env` - 环境变量文件

## 服务器环境要求

### 系统要求
- Linux系统 (Ubuntu 20.04+ / CentOS 7+)
- Python 3.8+
- Nginx
- Git

### 安装必要软件

```bash
# 更新系统
sudo apt update

# 安装Python和pip
sudo apt install python3 python3-pip python3-venv

# 安装Nginx
sudo apt install nginx

# 安装Git
sudo apt install git

# 安装Supervisor (进程管理)
sudo apt install supervisor
```

## 首次部署配置

### 1. 克隆仓库

```bash
cd /var/www/  # 或其他目录
git clone https://github.com/your-username/项目管理系统.git
cd 项目管理系统
```

### 2. 配置后端

```bash
cd backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 创建.env文件
cat > .env << EOF
DEBUG=False
SECRET_KEY=$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')
ALLOWED_HOSTS=your-domain.com,your-ip,localhost
CORS_ALLOWED_ORIGINS=http://your-domain.com:8080,http://your-ip:8080
EOF

# 数据库迁移
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 收集静态文件
python manage.py collectstatic --noinput
```

### 3. 配置Nginx

```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/project-management

# 粘贴以下内容（根据实际情况修改）
server {
    listen 8080;
    server_name your-domain.com;
    
    client_max_body_size 100M;
    
    # 前端静态文件
    location / {
        root /var/www/项目管理系统/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Django管理后台
    location /admin/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 静态文件
    location /static/ {
        alias /var/www/项目管理系统/backend/staticfiles/;
    }
    
    # 媒体文件
    location /media/ {
        alias /var/www/项目管理系统/backend/media/;
    }
}

# 启用配置
sudo ln -s /etc/nginx/sites-available/project-management /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 4. 配置Supervisor

```bash
# 创建Supervisor配置
sudo nano /etc/supervisor/conf.d/project_backend.conf

# 粘贴以下内容（根据实际情况修改）
[program:project_backend]
command=/var/www/项目管理系统/backend/venv/bin/gunicorn --bind 127.0.0.1:8000 --workers 3 project_management.wsgi:application
directory=/var/www/项目管理系统/backend
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/project_backend.log
stderr_logfile=/var/log/project_backend_err.log

# 更新Supervisor
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start project_backend
```

## 日常更新流程

### 本地操作

```bash
# 1. 修改代码后，打包前端
cd frontend
npm run build

# 2. 提交到Git
cd ..
git add .
git commit -m "描述你的更新"
git push origin main
```

### 服务器操作

```bash
# 1. 拉取代码
cd /var/www/项目管理系统
git pull origin main

# 2. 运行部署脚本
./deploy.sh
```

## 部署脚本说明

`deploy.sh` 脚本会自动执行：
1. 激活Python虚拟环境
2. 安装/更新Python依赖
3. 执行数据库迁移
4. 收集静态文件
5. 重启后端服务
6. 重新加载Nginx

## 故障排查

### 查看后端日志
```bash
sudo tail -f /var/log/project_backend.log
```

### 查看Nginx日志
```bash
sudo tail -f /var/log/nginx/error.log
```

### 重启服务
```bash
# 重启后端
sudo supervisorctl restart project_backend

# 重启Nginx
sudo systemctl restart nginx
```

### 检查服务状态
```bash
# 检查后端状态
sudo supervisorctl status project_backend

# 检查Nginx状态
sudo systemctl status nginx
```

## 安全建议

1. 使用强密码和密钥认证SSH
2. 配置防火墙，只开放必要端口
3. 定期备份数据库
4. 使用HTTPS (配置SSL证书)
5. 定期更新系统和依赖包
6. 不要将`.env`文件提交到Git

## 备份与恢复

### 备份数据库
```bash
cd /var/www/项目管理系统/backend
python manage.py dumpdata > backup_$(date +%Y%m%d).json
```

### 恢复数据库
```bash
python manage.py loaddata backup_20231017.json
```

